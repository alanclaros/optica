{% load jinja_tags %}
{% load static %}

{% if operation_x == 'add' %}
<link rel="stylesheet" href="{% static 'js/autosuggest/autosuggest.css' %}">
<script type="text/javascript" src="{% static "" %}js/autosuggest/autosuggest.js"></script>
<!-- Autosuggest data: -->
<script type="text/javascript">
    var suggest_custom_array_2 = [
        {% for tipo_montura in tipos_montura_lista %}
    ['{{tipo_montura.proveedor_id.proveedor}} - {{tipo_montura.tipo_montura}} ({{tipo_montura.numero_actual}})', '{{tipo_montura.tipo_montura_id}}'],
        {% endfor %}
    ];
</script>
{% endif %}

<!--contenedor-->
<div class="row align-items-center">
    <div class="col-sm-2">&nbsp;</div>
    <div class="col-md-8">
        <!--contenido-->
        <!--alerts-->
        {% include 'partials/_alerts.html' %}
        <br>
        {% if puede_anular == 0 %}
        {% with title='Ingresos Almacen' body='No puede Anular este ingreso, tiene registros en otros modulos, consulte con el administrador' %}
        {% include 'partials/_alert_info_cant_delete.html' %}
        {% endwith %}
        {% endif %}
        <div class="link_blue right">
            <span class="link_blue pointer" onclick="backWindow();">Volver</span>
        </div>
        <br>
        <form name="formulario" method="post" action="" onsubmit="return false;">
            {% csrf_token %}
            <table class="table3 w-100">
                <tr>
                    <th colspan="4" class="center w-100">
                        {% if operation_x == "add" %}Adicionar Ingreso Almacen{% endif %}
                        {% if operation_x == "anular" %}Anular Ingreso Almacen{% endif %}
                    </th>
                </tr>

                <tr class="back1">
                    <td class="right w-20">
                        Almacen&nbsp;:&nbsp;
                    </td>
                    <td colspan="3" class="left w-80">
                        <select name="almacen" id="almacen" class="form-control input w-99" onchange="iaSeleccionAlmacenMontura();" {% if operation_x == "anular" %}readonly='readonly' {% endif %}>
                            <option value="0">---</option>
                            {% for almacen in lista_almacenes %}
                            <option value="{{almacen.almacen_id}}" {% if registro.almacen_id.almacen_id == almacen.almacen_id %}selected{% endif %}>
                                {{almacen.sucursal_id.sucursal}}-{{almacen.almacen}}</option>
                            {% endfor %}
                        </select>
                    </td>
                </tr>
                
                <tr class="back2">
                    <td class="right w-20">
                        T. Montura&nbsp;:&nbsp;
                    </td>
                    <td colspan="3" class="left w-80">
                        <input type="hidden" name="tipo_montura" id="tipo_montura" value="0" />
                        <input type="text" autocomplete="off" id="tb2_tipo_montura" class="form-control input search left w-99" value="{{registro.tipo_montura_id.tipo_montura}}" />
                        <script type="text/javascript"> new autosuggest(suggest_custom_array_2, "tb2_tipo_montura", null, function (index, control) { seleccionPIA('tipo_montura', control.keywords[index], control.values[index]); });
                        </script>
                    </td>
                </tr>

                <tr class="back1">
                    <td class="right w-20">
                        Concepto&nbsp;:&nbsp;
                    </td>
                    <td colspan="3" class="left w-80">
                        <input type="text" autocomplete="off" value="{{registro.concepto}}" {% if operation_x == 'anular' %}readonly="readonly" {% endif %} class="form-control input left w-99" name="concepto" id="concepto" onkeyup="txtValid(this);"
                            onblur="txtValid(this);" maxlength="250">
                    </td>
                </tr>
                
                <tr class="back2">
                    <td class="right w-20">
                        Cantidad&nbsp;:&nbsp;
                    </td>
                    <td class="left w-30">
                        <input type="text" autocomplete="off" value="{{registro.cantidad_monturas}}" {% if operation_x == 'anular' %}readonly="readonly" {% endif %} class="form-control input right w-50" name="cantidad_montura" id="cantidad_montura" onkeyup="txtValid(this);"
                            onblur="txtValid(this);" maxlength="2">
                    </td>
                    <td class="right w-20">
                        {% if operation_x == 'add' %}
                        <button class="btn btn-primary btn-sm" id="btn_generar" onclick="iaGenerar();">
                            <i class="nav-icon fa fa-table"></i>&nbsp;&nbsp;Generar
                        </button>
                        {% endif %}
                    </td>
                    <td class="left w-30">
                        &nbsp;
                    </td>
                </tr>
            </table>
            <table class="table3 w-100">
                <tr>
                    <th colspan="4" class="w-100 center">Monturas</th>
                </tr>
                <tr class="back1">
                    <td class="w-50 left">
                        &nbsp;
                    </td>
                    <td class="w-15 right">
                        <i>Cant.</i>&nbsp;
                    </td>
                    <td class="w-15 right">
                        <i>Costo</i>&nbsp;
                    </td>
                    <td class="w-20 right">
                        <i>Total</i>&nbsp;
                    </td>
                </tr>

                {% if operation_x == 'add' %}
                {% for fila in filas %}
                <tr class="back{{forloop.counter|back_class}}" id="fila_{{fila}}" style="display: {% if forloop.counter == 1 %}display{% else %}none{% endif %};">
                    <td class="w-50 left">
                        <input type="text" autocomplete="off" id="tipo_montura_nombre_{{fila}}" name="tipo_montura_nombre_{{fila}}" class="form-control input left w-99" value="" readonly="readonly" />
                    </td>
                    <td class="w-15 right">
                        <input type="text" name="cantidad_{{fila}}" autocomplete="off" id="cantidad_{{fila}}" class="form-control input w-98 right" value="1" readonly="readonly">
                    </td>
                    <td class="w-15 right">
                        <input type="text" name="costo_{{fila}}" autocomplete="off" id="costo_{{fila}}" class="form-control input w-98 right" onkeyup="validarNumeroPunto(this); calcularTotalesIA();"
                            value="1">
                    </td>
                    <td class="w-20 right">
                        <input type="text" name="total_{{fila}}" id="total_{{fila}}" class="form-control input w-98 right" readonly="readonly">
                    </td>
                </tr>
                {% endfor %}

                <tr class="back1">
                    <td class="w-50 right">
                        <i>Totales :</i>&nbsp;
                    </td>
                    <td class="w-15 right">
                        &nbsp;
                    </td>
                    <td class="w-15 right">
                        &nbsp;
                    </td>
                    <td class="w-20 right">
                        <input type="text" name="total" id="total" class="form-control input right w-98" readonly="readonly">
                    </td>
                </tr>
                {% endif %}
                {% if operation_x == 'anular' %}
                {% for detalle in detalles %}
                <tr class="back{{forloop.counter|back_class}}">
                    <td class="w-50 left">
                        {{detalle.nombre_montura}}
                    </td>
                    <td class="w-15 right">
                        {{detalle.cantidad}}
                    </td>
                    <td class="w-15 right">
                        {{detalle.costo}}
                    </td>
                    <td class="w-20 right">
                        {{detalle.total}}
                    </td>
                </tr>
                {% endfor %}
                {% endif %}

                {% if operation_x == 'anular' %}
                <tr class="back1">
                    <td class="right w-50">
                        Motivo&nbsp;:&nbsp;
                    </td>
                    <td colspan="3" class="left w-50">
                        <input type="text" class="form-control input w-98" onkeyup="txtValid(this);" onblur="txtValid(this);" autocomplete="off" value="" maxlength="250" name="motivo_anula" id="motivo_anula">
                    </td>
                </tr>
                {% endif %}

            </table>
            
            <div id="div_listap" style="display: {% if operation_x == 'add' %}none{% endif %};">
                <table class="table3 w-100">
                    <tr class="back2">
                        <td colspan="4" class="center w-100">&nbsp;</td>
                    </tr>
                    <tr class="back1">
                        <td colspan="4" class="center w-100">
                            {% if operation_x == "add" %}
                            <button class="btn btn-secondary btn-sm" name="button_cancel" onclick="backWindow();">
                                <i class="nav-icon fas fa-arrow-alt-circle-left"></i>&nbsp;&nbsp;Cancelar
                            </button>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                            <button class="btn btn-primary btn-sm" name="add_button" onclick="sendFormIA('add', '');">
                                <i class="nav-icon fas fa-save"></i>&nbsp;&nbsp;Guardar
                            </button>
                            <input type="hidden" name="add_x" value="acc">
                            <input type="hidden" name="control_form" value="{{control_form}}">
                            {% endif %}
                            {% if operation_x == "anular" and puede_anular == 1 %}
                            <button class="btn btn-secondary btn-sm" name="button_cancel" onclick="backWindow();">
                                <i class="nav-icon fas fa-arrow-alt-circle-left"></i>&nbsp;&nbsp;Cancelar
                            </button>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                            <button class="btn btn-danger btn-sm" name="add_button" onclick="sendFormIA('anular', 'este Ingreso');">
                                <i class="nav-icon far fa-times-circle"></i>&nbsp;&nbsp;Anular
                            </button>
                            <input type="hidden" name="anular_x" value="acc">
                            <input type="hidden" name="control_form" value="txt|2|S|motivo_anula|Motivo Anulacion">
                            {% endif %}
                            <input type="hidden" id="url_main" value="{{url_main}}">
                            <input type="hidden" id="operation_x" name="operation_x" value="{{operation_x}}">
                            <input type="hidden" name="module_x" value="{{module_x}}">
                            <input type="hidden" name="id" value="{{id}}">
                        </td>
                    </tr>
                </table>
            </div>
        </form>
        <br>
    </div>
    <!--fin div contenido-->
    <div class="col-sm-2">&nbsp;</div>
</div>
<!--fin div contenedor-->
<form name="form_cancel" method="post" action="{{url_main}}">
    {% csrf_token %}
</form>

<form name="form_operation" method="post" action="{{url_main}}">
    {% csrf_token %}
    <input type="hidden" name="module_x" value="{{module_x}}">
    <input type="hidden" name="module_x2" value="{{module_x2}}">
    <input type="hidden" name="module_x3" value="{{module_x3}}">
    
    <input type="hidden" name="operation_x" value="{{operation_x}}">
    <input type="hidden" name="operation_x2" value="{{operation_x2}}">
    <input type="hidden" name="operation_x3" value="{{operation_x3}}">
    
    <input type="hidden" name="id" value="{{id}}">
    <input type="hidden" name="id2" value="{{id2}}">
    <input type="hidden" name="id3" value="{{id3}}">
</form>
